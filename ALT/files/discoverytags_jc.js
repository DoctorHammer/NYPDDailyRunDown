/*
 *  (c) 2000-2020 deviantART, Inc. All rights reserved.
 */
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/difi.js","jms/lib/pubsub.js","jms/lib/autocomplete.js",".domready"],function(){window.DiscoveryTags=GMIBase.extend({$tags:void 0,isILE:void 0,isEclipse:void 0,$saveTo:void 0,isAutocomplete:!0,inputType:"tag",limit:0,gmiConstructor:function(){this.$tags=this.$.find(".tags"),this.isILE=this.$.closest(".ile-tags").length>0,this.isEclipse=this.$.closest(".eclipse").length>0,this.isAutocomplete=void 0===this.$.data("autocomplete")||1==this.$.data("autocomplete"),this.inputType=void 0===this.$.data("inputType")?"tag":this.$.data("inputType"),this.$saveTo=this.$.find(this.$.data("saveto")),this.limit=this.$.data("limit"),this.bind(),PubSub.publish("DiscoveryTags.initialized",this)},createTagElement:function(t,e){var a=this.validate(t);return $tag=$("<span>").text(t),$tag.data("is-valid",a).data("tag-context",e),a&&$tag.data("tag-name",t),$('<span class="tag">').toggleClass("invalid",!a).append($tag," ")},editTagSelection:function(t){var e,a,i,n,s,r,o,l,d,c=$(t.startContainer),g=$(t.endContainer);return t.startContainer instanceof Text?(r=t.startContainer.data.substr(0,t.startOffset),e=c.closest(".tag")):e=c.children().eq(t.startOffset),t.endContainer instanceof Text?(o=t.endContainer.data.substr(t.endOffset),a=g.closest(".tag")):a=g.children().eq(t.endOffset-1),t.startContainer==t.endContainer&&t.startContainer instanceof Text?(this.editTag(e,[t.startOffset,t.endOffset]),void 0):(e.prev(".tag").length>0?l=e.prev(".tag"):d=this.$tags,this.$tags.find("span").addClass("noblur"),i=$(t.extractContents()).text().replace(/\s+/g," ").trim(),n=$('<span class="tags-widget-input">').data("edit",!0).text(i).prop("tabindex","0").prop("contenteditable",!0),s=$('<span class="tag">').append(n," "),l?(o&&l.after(this.createTagElement(o)),l.after(s),r&&l.after(this.createTagElement(r))):(o&&d.prepend(this.createTagElement(o)),d.prepend(s),r&&d.prepend(this.createTagElement(r))),e.remove(),a.remove(),this.$tags.find("span").removeClass("noblur"),this.setEditorSelection(n,!0),void 0)},repaintTags:function(){var t=this;this.$tags.children("span.tag").each(function(){var e=$(this),a=e.children("span").text();e.hasClass("invalid")&&t.validate(a)&&e.removeClass("invalid").children("span").data("tag-name",a)})},bind:function(){var t=this;this.$tags.on("click",".tag span, .tag.invalid",function(){return t.isEclipse?($(this).data("tagName")||!$(this).data("is-valid"))&&($(this).closest(".tag").remove(),t.repaintTags()):t.editTag($(this).closest(".tag"),!0),!1});var e=null;this.$.on("mousedown",function(t){var a=$(t.target);e=t.timeStamp,a.closest(".tags-widget").addClass("nofocus",t)}),this.$.on("mouseup",function(a){var i=$(a.target);if(!i.hasClass("tags-widget-input")){if(i.closest(".tags-widget").removeClass("nofocus"),500>a.timeStamp-e)return a.preventDefault(),t.getInputField().focus(),!1;if(window.getSelection&&window.getSelection().rangeCount){var n=window.getSelection().getRangeAt(0);return a.preventDefault(),t.editTagSelection(n),!1}}}),this.$.on("focus",function(e){$(e.target).is(".tags-widget:not(.nofocus)")&&t.getInputField().focus()}),this.$tags.on("focus",".tags-widget-input",function(e){e.preventDefault(),t.$.find(".placeholder").hide()}),this.$.on("blur",".tags-widget-input:not(.noblur)",function(){t.createTag($(this),-1),t.save()});var a=null,i=function(e,i){return function(){var n,s,r,o,l,d;if(i){if(o=window.getSelection(),!(o.rangeCount>0))return;if(l=o.getRangeAt(0),d=$(l.commonAncestorContainer).closest(".tags-widget-input"),!(d.length>0&&d.get(0)==e.get(0)))return;n=e.text(),s=n.slice(0,l.startOffset),r=n.slice(l.endOffset)}else i=e.text();i=i.replace(/(?:\r\n|\r|\n)/g," "),i=i.replace(/<[^>]+>/g," ").replace(/[\x21-\x2B\x2E\x2F\x3A-\x40\x5B-\x5E\x60\x7B-\x7E\f]/g,""),e.text(s+i+r);var c=s.length+i.length;t.setEditorSelection(e,c),a=null}};this.$.on("paste",".tags-widget-input",function(t){a&&clearTimeout(a);var e=t.originalEvent.clipboardData||window.clipboardData,n=e&&e.getData("text"),s=$(t.target);n?(t.preventDefault(),i(s,n)()):a=setTimeout(i(s),10)}),this.$.on("keydown",".tags-widget-input:not(.noblur)",function(e){var a,i,n,s,r,o,l=$(this);try{i=window.getSelection(),i.rangeCount||i.collapse(this,0),a=i.getRangeAt(0)}catch(d){return ddt.log("discoverytags","getRangeAt blew up",d,i,a),void 0}if(n=a.startContainer instanceof Text?a.startOffset:a.startOffset>0?0:-1,(e.ctrlKey||e.metaKey)&&65==e.keyCode)return function(t){if(document.selection){var e=document.body.createTextRange();e.moveToElementText(t),e.select()}else if(window.getSelection){var e=document.createRange();e.selectNode(t),window.getSelection().removeAllRanges(),window.getSelection().addRange(e)}}(l.get(0)),e.preventDefault(),!1;switch(e.keyCode){case 13:case 32:case 188:return e.preventDefault(),l.text().length>0&&(t.createTag(l,n),t.save()),!1;case 8:var c,g=a.endOffset,u=l.text().trim();if(l.data("edit")){if(a.collapsed){if(n>0)return!0}else if(a.startContainer==a.endContainer&&a.startContainer instanceof Text)return!0;l.addClass("noblur"),r=l.closest(".tag"),o=r.prev(".tag"),r.remove(),o?(c=o.text().trim(),o.text(c+u),t.editTag(o,[c.length,c.length])):t.getInputField().focus()}else{if(u&&(n>0||g>0))return!0;r=t.$tags.children(".tag"),r.length>1&&(t.removeInputField(),t.editTag(r.eq(-2)))}return!1;case 65:if(e.metaKey){var i=window.getSelection();return a=document.createRange(),t.createTag(l,-1),t.save(),a.setStart(t.$tags.get(0),0),a.setEnd(t.$tags.get(0),t.$tags.children().length),i.removeAllRanges(),i.addRange(a),t.editTagSelection(a),!1}break;case 39:if(s=l.text().length,n==s-1){var a=document.createRange(),i=window.getSelection();a.setStart(l.get(0).childNodes[0],n+1),a.collapse(!0),i.removeAllRanges(),i.addRange(a),e.preventDefault()}else n==s&&(r=l.closest(".tag").next(".tag"),r.length&&(e.preventDefault(),t.createTag(l,-1),t.save(),t.editTag(r,0)));break;case 37:0==n&&a.collapsed&&(r=l.closest(".tag").prev(".tag"),r.length&&(e.preventDefault(),t.createTag(l,-1),t.save(),t.editTag(r)))}return!0}),this.$.on("dautocompleted",".tags-widget-input",function(){t.createTag($(this),-1,"autocomplete"),t.save(),t.getInputField().focus()})},getTagNames:function(){var t=[];return this.$tags.find(".tag span").each(function(){$(this).data("tag-name")&&t.push([$(this).data("tag-name"),$(this).data("tag-context")||"typed"])}),t},save:function(){var t,e=this.getTagNames();t="username"===this.inputType?e.map(function(t){return t[0]}).join(","):JSON.stringify(e),this.$saveTo.val(t),this.$.trigger("tagchange",t),e.length?this.$.find(".placeholder").hide():this.$.find(".placeholder").show(),this.isILE&&PubSub.publish("InlineEditor.change",{UpdateTags:t})},validate:function(t){var e="validate"+this.inputType.charAt(0).toUpperCase()+this.inputType.slice(1);return this[e](t)},validateUsername:function(t){return/[A-Za-z0-9][A-Za-z0-9-]{1,18}[A-Za-z0-9]$/.test(t)?3>t.length||t.length>20?!1:this.limit&&this.getTagNames().length>=this.limit?!1:!0:!1},validateTag:function(t){if(!/^(\w|[^\u0000-\u007F])+$/.test(t))return!1;var e=t.replace(/[\u00A0-\u2666]/g,function(t){return"&#"+t.charCodeAt(0)+";"});return e.length>255?!1:this.limit&&this.getTagNames().length>=this.limit?!1:!0},tagExists:function(t){for(var e=this.getTagNames(),a=t.toLowerCase(),i=0;e.length>i;i++)if(a==e[i][0].toLowerCase())return!0;return!1},createTag:function(t,e,a){var i,n=t.text().trim(),s=0>e?n:n.slice(0,e),r=0>e?"":n.slice(e),o=null,l=t.closest(".tag");t.addClass("noblur");for(var d=s.split(/[\s,]+/),c=0;d.length>c;c++)i=d[c].trim(),i&&("#"==i.charAt(0)&&(i=i.substr(1)),l.before(this.createTagElement(i,a)));e>-1?(t.text(r),o=t):(l.remove(),t=null),o&&this.setEditorSelection(o,e>-1?0:!0),t&&t.removeClass("noblur")},editTag:function(t,e){var a,i;t.find("span").data("edit")||(a=t.text().trim(),i=$('<span class="tags-widget-input">').data("edit",!0).text(a).prop("tabindex","0").prop("contenteditable",!0),this.isAutocomplete&&(this.autocomplete=new DAutoCompleteTags(i,!1,{trailing_char:null,no_hash:!0})),t.empty().append(i," ").removeClass("invalid"),this.setEditorSelection(i,e))},setEditorSelection:function(t,e){var a,i=document.createRange(),n=window.getSelection();t.focus(),e===!0?i.selectNodeContents(t.get(0).childNodes[0]):$.isArray(e)?(i.setStart(t.get(0).childNodes[0],e[0]),i.setEnd(t.get(0).childNodes[0],e[1])):null!=e?(0>e&&(a=t.text(),e=a.length+e+1),i.setStart(t.get(0).childNodes[0],e),i.collapse(!0)):(i.selectNodeContents(t.get(0).childNodes[0]),i.collapse(!1)),n.removeAllRanges(),n.addRange(i)},getInputField:function(){var t=this,e=this.$tags.find(".tags-widget-input");if(0==e.length){var a="tag";t.isEclipse&&(a+=" tag-eclipse-new"),e=$('<span class="tags-widget-input final">').prop("tabindex","0").prop("contenteditable",!0),this.$tags.append($('<span class="'+a+'">').append(e," ")),this.isAutocomplete&&(this.autocomplete=new DAutoCompleteTags(e,!1,{trailing_char:null,no_hash:!0}))}return e},removeInputField:function(){var t=this.$tags.children(".tag").last();t.find(".tags-widget-input").addClass("noblur"),t.closest(".tag").remove()},clear:function(){this.$tags.empty(),this.save()}}),DWait.init("DiscoveryTag.activity_form",function(){PubSub.subscribe([{eventname:"FeedStatus.init",subscriber:this,callback:function(t,e){var a=e.writer?e.writer.$node.parents(".discoverytag_activity_form"):!1;a&&a.length&&(PubSub.unsubscribe([{eventname:"FeedStatus.init",subscriber:this}]),e.writer.setInitialText("#"+a.data("tag")))}.bind(this)},{eventname:"WriterAnywhere.activation_aborted",subscriber:this,callback:function(t,e){var a=e.parents(".discoverytag_activity_form");a&&a.length&&(PubSub.unsubscribe([{eventname:"WriterAnywhere.activation_aborted",subscriber:this}]),e.val("#"+a.data("tag")))}.bind(this)},{eventname:"FeedStatus.posted",subscriber:this,callback:function(t,e){var a=$(".discoverytag_activity_feed:visible"),i=$(e.content);if(a.get().length){var n=i.find(".feed-action-details .username");n.find(".feed-action-details-type").remove(),n.children("a").remove();var s=["<li>",'<span class="feed_user_wrapper">',n.html(),"</span>",i.find(".feed-action-status-content").html(),'<span class="timeago">',i.find(".feed-action-details .time").html(),"</span>","</li>"].join("");a.prepend(s)}}.bind(this)}])}),DWait.init("DiscoveryTag.deviation_tags",function(t){var e=$(t),a=e.siblings(".hidden-discovery-tags");e.click(function(t){t.preventDefault(),a.is(":visible")?(e.text(e.data("label-collapsed")),a.hide()):(e.text(e.data("label-expanded")),a.show())})}),window.DWait&&DWait.run("jms/pages/widgets/discoverytags.js")});if(window.DWait){DWait.count()}